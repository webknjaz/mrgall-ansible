---

- hosts: dokku
  roles:
  - role: rclone

  - role: acl

  - role: security

  - role: yoshzz.dokku
    dokku_vhost: dokku.mrgall.com
    dokku_version: 0.9.4
    dokku_plugins:
    - name: acl
      repo: https://github.com/dokku-community/dokku-acl.git
    - name: docker-options
      repo: https://github.com/dyson/dokku-docker-options.git
    - name: letsencrypt
      repo: https://github.com/dokku/dokku-letsencrypt.git
    - name: maintenance
      repo: https://github.com/dokku/dokku-maintenance.git
    - name: mariadb
      repo: https://github.com/dokku/dokku-mariadb.git

  - role: dokku_users
    remove_dokku_users: []
    add_dokku_users:
    - name: wk
      ssh_public_key: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDKfVXabLvtPE8LhoD1+CjZ0hQHLq24eYo3fqFxGfp9IWNN8pXUQH1VpiSs9qd+YQH2KeiJubXaLG61fm+hRLreNn8HLu1sQEgmeLjl2IREk/yrfEWiPuoboN90KHy187gK515yVQmx1HFqQ9112fpVhnbyU/4D2sx07kpUDIR97OC1NW+XQjlWF0+tRh1xU+EEALQbzSVBLobz0DNlUPzDg2vNLbIcYSGvfiYGyj5Opb/tnK3JNN8EzYxZInBcVE52oLOYM3jPkiVWUuTFp5zq12JCiGXrxiPA4KtB/QjD6CbVHBc+eDMTFqMD26CjAuaSg6O/nCY7CSapESxDuVfd wk@wk-laptop
    - name: gdg-autodeployer-bot
      ssh_public_key: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDeKhCJlpM7GCjgDYLD8PQ66HmkQCU1zE7GgMBzXO1efK5nLanHk1ze2UXDuToqFsE+PcUjbyeVJRpNEMzHoBl3TGvDSP7D7KLsWLQr8O291JyrDwpvo5MvZOqDvnRs3SiXxxYOh93RL3+VRvZQR+0afBDyrWkW1zXR3aWbzevBl+roq96MapWidWfV5KdDehw1MC7DO4/PGybXNUSc7QPJfxUYO37l+324y5PoG1vNcFBcnpBkysTvbQPgmRLObFY5mLv6IF4Ss5ijn4aCfEhDWmmpDRAZpSEsurEMejKm3WOUbe4lygEhJ0XZ/CGcwlyaVOvlEHeIry+bXeGziEEudeOQxups1ogJ57gfmD+PXzroKu4rwmPmYijF536/GzeOv+U6ryH/7YSmJ7mLvc4hJhsWHexe0xq2o4BuSeXlCgyiAinSIiYnoU+BaCmi59JNgnYqKU8rnlCIkNVwHSIAu5pjdaA8mtJmLYFLDPAibTUZl+6Vzv1q7zXoKUjyCbmdj1jVPuwGyxCvVZRl7N+YiXjyrV9G2VDLzvjPQZVsuXTbjy3NFvD/NCeQu7gEd1Lmpy2yhh9kwHX8CJGIrJJMQ3yNDC4VAhLZI3LzobjzC1jiONINHyUtJ4lTIwsBMuE1l/KyMeT0ohp6v53Sv8HmoJ5o4B+UerpeSqonSl9ruQ== dokku app deployment key
    - name: mrgall
      ssh_public_key: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDFFzDPvc8875TegWwPNzBv1ZS21sEs+7XVvweFO6kUqOmWoThdlQBr4nTHIYXFVVvJ9VWmtL9sWjpJtK30xLRdsoe91N/9FyAZWQsN6pmPGU2MvUbKnaWGoa6q3s3uc6x2Vg/X9RcOlrDCxhvXzBY4xLQZGL8qRaeqvAQwH9yrpLeTK663QwLEjjardUVkQYe7CzaEJY/zAmdzDXUT0j0UnGK9LPjVU+CKiIyewIL7Cz+HDfucURysQDGINW3flVGH73Mf2RJOKYRaPaHrI97zDZGWPJptwGViQQikryZmJ58mhUhu2rYsuElIs0WVczJb8hCrfq3kcp7ps+JeVxRNKF0gqI3aqJ4mwM87KAB3Fiqr0Ho4LM3iIfm51/pL6XqknZSqKSzLxOXOV+G4pNQJ3QSXs8VcYSc/AYN6lR+cZtvTYt4s36vamUsgrMZP5YaJpDGsrI4HQz96Zm64p1LwAG7hU2nuVxMnun0z33SuySMVJZ8H6qK5q+wwMuI2qALs/rf+QDzIq0F0XiBYVK/9EAP38tNmE87zy6GCasOG3xhwfefLJxqI9jv9WeWyLCCIh9JKmb9NVBN3+Gqt9rzBR7c8dkKZAnORg6zsIv1VlDSXBWQBAlWeFj85nLx1nkVvKSd3oXiL1dNdDG/fg32q7KZMsVCO9d8GPZOPdBoWbQ== mrgall@home.mrgall.com

  - role: dokku_apps
    mariadb_backup_dir: /var/lib/dokku/backups/mariadb
    apps:
    - name: gdg.org.ua
      env_vars:
        - ENV=production
        - &setuptools_app_ver SETUPTOOLS_SCM_PRETEND_VERSION=1
        - BASE_APP_URL=https://gdg.org.ua
        - &gdg_app_cwd APP_ROOT=/app
        - &gdg_cache_dir CACHE_ROOT=/app/.cache
        - &gdg_tmpl_dir TEMPLATES_ROOT=/app/src/GDGUkraine/templates
        # Google creds:
        - &gapp_id !vault |
          $ANSIBLE_VAULT;1.1;AES256
          61633730366233653161393262666332663035363061643936663262343438643334323932363335
          6663636239653965313838613265343866306539353265370a656463623736613230343932643737
          65386565666233323731373961363566343166396465623961626632366163666535333362636436
          6364383031376238340a313838663334313561333261323937326331346361376438623438613064
          37333035646230343132343265333435393939653533343061366330643766643964613230303335
          37613436393637356663613132643566626564343830626666616130633866376664613838623434
          613965326334343032323036336666636166
        - &gapp_secret !vault |
          $ANSIBLE_VAULT;1.1;AES256
          62316536353737353433366530313437333539616239303533303766336133393965636639633734
          3532363830666339346362396333363861653439373339630a393761663034353135383861336137
          30666235303931356431373265623332616466666366643764383962353033363766343231333239
          3461316536353231350a613637646636326430623933343836636263356632653335636135386463
          34616139396338346162353132646562346237333033633763643339386563643362316466363332
          3862653164343766323638333830383733323866336536353035
        - &card_crypt_key !vault |
          $ANSIBLE_VAULT;1.1;AES256
          35303733363234626433616435396536383132363134643036643961333437333937336461363838
          6435326431306262373862666535656634656230623164340a396139383639323862313939346335
          36653665653962356561666535366639666466373533643830363361333232303766366562363239
          6337623231323736370a303737306235396366663035316136383338616561353530313132316239
          65376237643738303335363763303262646234643435343961306661663665633636363334393962
          62383365613961343434656134623239663163633132303039313139613031356338633562636664
          636164626633376131303735663039633263
      remove_acl_users: []
      acl_users: &gdg_acl_deployers
      - gdg-autodeployer-bot
      - wk
      domains:
      - gdg.org.ua
      - www.gdg.org.ua
      mariadb: true
      ssl: true
      email: &letsencrypt_email mrgall@mrgall.com
    - name: dev.gdg.org.ua
      env_vars:
        - ENV=
        - *setuptools_app_ver
        - BASE_APP_URL=https://dev.gdg.org.ua
        - *gdg_app_cwd
        - *gdg_cache_dir
        - *gdg_tmpl_dir
        - *gapp_id
        - *gapp_secret
        - *card_crypt_key
      remove_acl_users: []
      acl_users: *gdg_acl_deployers
      domains:
      - dev.gdg.org.ua
      - www.dev.gdg.org.ua
      mariadb: true
      ssl: true
      email: *letsencrypt_email

# vim: ft=ansible:
