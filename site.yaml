---

- hosts: dokku
  tasks:

  - import_role:
      name: acl

  - import_role:
      name: security

  - import_role:
      name: yoshzz.dokku
    vars:
      dokku_vhost: dokku.mrgall.com
      dokku_version: 0.9.4
      dokku_plugins:
      - name: acl
        repo: https://github.com/dokku-community/dokku-acl.git
      - name: docker-options
        repo: https://github.com/dyson/dokku-docker-options.git
      - name: letsencrypt
        repo: https://github.com/dokku/dokku-letsencrypt.git
      - name: maintenance
        repo: https://github.com/dokku/dokku-maintenance.git
      - name: mariadb
        repo: https://github.com/dokku/dokku-mariadb.git

  - import_role:
      name: dokku_users
    vars:
      remove_dokku_users: []
      add_dokku_users:
      - name: wk
        ssh_public_key: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDKfVXabLvtPE8LhoD1+CjZ0hQHLq24eYo3fqFxGfp9IWNN8pXUQH1VpiSs9qd+YQH2KeiJubXaLG61fm+hRLreNn8HLu1sQEgmeLjl2IREk/yrfEWiPuoboN90KHy187gK515yVQmx1HFqQ9112fpVhnbyU/4D2sx07kpUDIR97OC1NW+XQjlWF0+tRh1xU+EEALQbzSVBLobz0DNlUPzDg2vNLbIcYSGvfiYGyj5Opb/tnK3JNN8EzYxZInBcVE52oLOYM3jPkiVWUuTFp5zq12JCiGXrxiPA4KtB/QjD6CbVHBc+eDMTFqMD26CjAuaSg6O/nCY7CSapESxDuVfd wk@wk-laptop
      - name: wk-nat
        ssh_public_key: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDAfswbWzDhmEXqrSWv4gMEDWALDN7c0//FTw5diIOMwQz3/wIfZgby9aAyD7Vk7+E/uhmNWscJt56C8LPtC3np1MxPy7bVR89sZz1Bf3mBL6+t3X/oohEVAP/QMEtDePrrkMU/vKhKAVwwYDTii0wIvTGrLOl2Dv4d+gU8OMG8Cf4ASIR21W48hSsHFaNhtQMUez99XjzXqsrPb1nIess3qt2GUzthA0fkzjxSZy1M8451ZOzyp6hiDTMPbB/Rc3zTzRIfRcvf8P4XjpX2wpUXa9C428zHN+nvfqClMnZafuM/kh6H+QuS8Nq+uH5nhiYZMwVeWTkfJB3zQctvjU4jdhxXglwonAL09dGSC5qpY4LnC1ogjiLsfz6d0LFO55FYITDH+1bTH8wfk4nKbVAuoM+wQhOg6KuX9UWVwcCkPfIQk9juW91h3zRu6KtQCI7vnLsxnT+IRhSpTO4l0N46utiFx7RBpBUUw5Pi9pL72j3VWj7vGG6tdC95mAQZDQhxITONxIDuSw/dWLCqNh5+jeecSAccvbduEJaYyZXiGkuq1M6wJ04bKvMamSqHL00ySFJPKOEEQfeUaKEcEOyecgZ1xwH4aU+s3jnGngBIEz3L5xK1Z1NkUO8Fo3czZYDB6O/83k+1CGcUuxwT2Kre2GiZNqnWVbTcj8wJS4J/JQ== wk@wk-nat
      - name: gdg-autodeployer-bot
        ssh_public_key: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDeKhCJlpM7GCjgDYLD8PQ66HmkQCU1zE7GgMBzXO1efK5nLanHk1ze2UXDuToqFsE+PcUjbyeVJRpNEMzHoBl3TGvDSP7D7KLsWLQr8O291JyrDwpvo5MvZOqDvnRs3SiXxxYOh93RL3+VRvZQR+0afBDyrWkW1zXR3aWbzevBl+roq96MapWidWfV5KdDehw1MC7DO4/PGybXNUSc7QPJfxUYO37l+324y5PoG1vNcFBcnpBkysTvbQPgmRLObFY5mLv6IF4Ss5ijn4aCfEhDWmmpDRAZpSEsurEMejKm3WOUbe4lygEhJ0XZ/CGcwlyaVOvlEHeIry+bXeGziEEudeOQxups1ogJ57gfmD+PXzroKu4rwmPmYijF536/GzeOv+U6ryH/7YSmJ7mLvc4hJhsWHexe0xq2o4BuSeXlCgyiAinSIiYnoU+BaCmi59JNgnYqKU8rnlCIkNVwHSIAu5pjdaA8mtJmLYFLDPAibTUZl+6Vzv1q7zXoKUjyCbmdj1jVPuwGyxCvVZRl7N+YiXjyrV9G2VDLzvjPQZVsuXTbjy3NFvD/NCeQu7gEd1Lmpy2yhh9kwHX8CJGIrJJMQ3yNDC4VAhLZI3LzobjzC1jiONINHyUtJ4lTIwsBMuE1l/KyMeT0ohp6v53Sv8HmoJ5o4B+UerpeSqonSl9ruQ== dokku app deployment key
      - name: mrgall
        ssh_public_key: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDFFzDPvc8875TegWwPNzBv1ZS21sEs+7XVvweFO6kUqOmWoThdlQBr4nTHIYXFVVvJ9VWmtL9sWjpJtK30xLRdsoe91N/9FyAZWQsN6pmPGU2MvUbKnaWGoa6q3s3uc6x2Vg/X9RcOlrDCxhvXzBY4xLQZGL8qRaeqvAQwH9yrpLeTK663QwLEjjardUVkQYe7CzaEJY/zAmdzDXUT0j0UnGK9LPjVU+CKiIyewIL7Cz+HDfucURysQDGINW3flVGH73Mf2RJOKYRaPaHrI97zDZGWPJptwGViQQikryZmJ58mhUhu2rYsuElIs0WVczJb8hCrfq3kcp7ps+JeVxRNKF0gqI3aqJ4mwM87KAB3Fiqr0Ho4LM3iIfm51/pL6XqknZSqKSzLxOXOV+G4pNQJ3QSXs8VcYSc/AYN6lR+cZtvTYt4s36vamUsgrMZP5YaJpDGsrI4HQz96Zm64p1LwAG7hU2nuVxMnun0z33SuySMVJZ8H6qK5q+wwMuI2qALs/rf+QDzIq0F0XiBYVK/9EAP38tNmE87zy6GCasOG3xhwfefLJxqI9jv9WeWyLCCIh9JKmb9NVBN3+Gqt9rzBR7c8dkKZAnORg6zsIv1VlDSXBWQBAlWeFj85nLx1nkVvKSd3oXiL1dNdDG/fg32q7KZMsVCO9d8GPZOPdBoWbQ== mrgall@home.mrgall.com
      - name: anxolerd
        ssh_public_key: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCa6dp7HjTGThPb4LnwudMcqzIyOERL+mMDtjJ3Kq5YuBGDdBIHIhJBw9+ndvMAWGXWoGx2Kll7u6wMFeY9GtIWFUsTK7hnQRiOQs096bqXZD/Wq/+HwAsnRzL6jxwh76XacuWbeVjR1CxUL57rNZ7zPwzj2l8bxMFfC2kEM5zfsTXoJnHMvwy0i/9unNidF6tpBUSUOqUXDAjsVSbZCziGvS2ZTiQWoKKh9gzyBNZyllqFXhgGgF9/drmjNwpz9wFdQkct6qClzkB4EcB5fclGio2C9YY825MjHNxRV1h5mSQz2F6E9eyPa/nG5HDBDS2jYOwl1/MN6TH4t2KPO0VX anxolerd@anxolerd-laptop

  - import_role:
      name: dokku_apps
    vars:
      mariadb_backup_dir: /var/lib/dokku/backups/mariadb
      apps:
      - name: gdg.org.ua
        env_vars:
        - ENV=production
        - &setuptools_app_ver SETUPTOOLS_SCM_PRETEND_VERSION=1
        - BASE_APP_URL=https://gdg.org.ua
        - &gdg_app_cwd APP_ROOT=/app
        - &gdg_cache_dir CACHE_ROOT=/app/.cache
        - &gdg_tmpl_dir TEMPLATES_ROOT=/app/src/GDGUkraine/templates
        # Google creds:
        - &gapp_id !vault |
            $ANSIBLE_VAULT;1.1;AES256
            61633730366233653161393262666332663035363061643936663262343438643334323932363335
            6663636239653965313838613265343866306539353265370a656463623736613230343932643737
            65386565666233323731373961363566343166396465623961626632366163666535333362636436
            6364383031376238340a313838663334313561333261323937326331346361376438623438613064
            37333035646230343132343265333435393939653533343061366330643766643964613230303335
            37613436393637356663613132643566626564343830626666616130633866376664613838623434
            613965326334343032323036336666636166
        - &gapp_secret !vault |
            $ANSIBLE_VAULT;1.1;AES256
            62316536353737353433366530313437333539616239303533303766336133393965636639633734
            3532363830666339346362396333363861653439373339630a393761663034353135383861336137
            30666235303931356431373265623332616466666366643764383962353033363766343231333239
            3461316536353231350a613637646636326430623933343836636263356632653335636135386463
            34616139396338346162353132646562346237333033633763643339386563643362316466363332
            3862653164343766323638333830383733323866336536353035
        - &card_crypt_key !vault |
            $ANSIBLE_VAULT;1.1;AES256
            35303733363234626433616435396536383132363134643036643961333437333937336461363838
            6435326431306262373862666535656634656230623164340a396139383639323862313939346335
            36653665653962356561666535366639666466373533643830363361333232303766366562363239
            6337623231323736370a303737306235396366663035316136383338616561353530313132316239
            65376237643738303335363763303262646234643435343961306661663665633636363334393962
            62383365613961343434656134623239663163633132303039313139613031356338633562636664
            636164626633376131303735663039633263
        remove_acl_users: []
        acl_users: &gdg_acl_deployers
        - gdg-autodeployer-bot
        - wk
        - anxolerd
        domains:
        - gdg.org.ua
        - www.gdg.org.ua
        mariadb: true
        ssl: true
        email: &letsencrypt_email mrgall@mrgall.com
      - name: dev.gdg.org.ua
        env_vars:
        - ENV=
        - *setuptools_app_ver
        - BASE_APP_URL=https://dev.gdg.org.ua
        - *gdg_app_cwd
        - *gdg_cache_dir
        - *gdg_tmpl_dir
        - *gapp_id
        - *gapp_secret
        - *card_crypt_key
        remove_acl_users: []
        acl_users: *gdg_acl_deployers
        domains:
        - dev.gdg.org.ua
        - www.dev.gdg.org.ua
        mariadb: true
        ssl: true
        email: *letsencrypt_email
      - name: kyiv.gdg.org.ua
        env_vars:
        - !vault |
            $ANSIBLE_VAULT;1.1;AES256
            62373634616565356263646231343764343463613364623234363736656435323065346463333637
            6264376566356430333336376138616330323736363964350a613630336331303235346164623835
            33363233373363393434373436343735326161316430303563373634343039316631346531383136
            3939333032396531390a616631333263303832393562633162333639366662303335333064663434
            36363933396333396330666436326638643561656434616561633466356130353436306266653464
            61366232623335356632666139646562636131306161313031343034353036326462656561363265
            34323465306638613335306434363435333262313739353566316130366362323231343932613265
            65663261323131396664
        - !vault |
            $ANSIBLE_VAULT;1.1;AES256
            65666236396562376430633136626431633136306361613130643234306564316266306337396338
            6463616165356365656631306661373863613730363866350a306434393466626635366563313733
            30333131353738363464656430353432633963356630626533393739336165363364333333376338
            6564373036333061320a666432306231303864613863303661613064636239363638353637353333
            64303966306364666237383731616139376631663063653266653633386437376531323261363336
            36303561643965666664373635613033373362356233633934646536623437376338356461653732
            30613965326561646638353634313962643261333163663363323236343636383862313363393461
            36333530663032613864366136353761653331323865663766373034383831396366353938393463
            6432
        - !vault |
            $ANSIBLE_VAULT;1.1;AES256
            66336265343538366565633765343037383935373831303935633039666433336363313734333930
            3062616462333164343832303836383830313237613462320a613066633866353138366136303230
            33316532336336333134346139306532666362306439323831343963346631393961613663396266
            3835333339376334620a303930653464363936353862356566376261316431666633616231633762
            33373630363731333930356165643065653964623835343831343634373639656463393462626435
            30646534306563636634333534323337336233383335656531383933643739313037343438333432
            32643163346631613330303730663537353264613465623433383663313539333238373037366636
            33343263666536643664613765393661636238393161366635323839366465656638376137326263
            3231
        - !vault |
            $ANSIBLE_VAULT;1.1;AES256
            38383735346438333363626535623132393136366661366139383832616564623532303963373463
            3062396363336433656163383561353535356566643732650a613165623665363463613363333834
            61396532323333623633313231643461333130646536353065613931336230663538383766356637
            6261356531663763380a643662353266386632666138396663303365343263323265306561343362
            35383034383161373463643637323538313231643261613739656130383731626466383339643437
            33306663616535383464303034646233376266366138326566613632363732333434646632323133
            38383338353538653536366262333337363137366362653935353463386637323339363463353266
            33366166656139363633
        - !vault |
            $ANSIBLE_VAULT;1.1;AES256
            38303862326630323438393634383365313638303437373164333931343631333565363533616362
            3332343739663866363161613136613234613966376239360a623064353663643038336663393438
            38656363666231303438316261363738613166636530376431353931333031336337356232363634
            6539306538633532330a343462636661306334613736343836653662656334353832343131666435
            39393732383830316338613965373464663532303038353363306566656235396264613261383136
            34666465326536353834626535623530633038306532663566383561646631366162333232386431
            39353337393334386633313735333362306664633864313534633335666339323863663362363031
            66613162343538653362
        - !vault |
            $ANSIBLE_VAULT;1.1;AES256
            62643732303539376430663961656139636334393363323839396261333965613666643037663933
            3566373038303234333639613466316433616366373563350a306436646363316266336134306138
            36373939623631373535323431636230613830646330623332633265396236616332323035393237
            6361323432393739320a316632383530366330643732356261643366663031366633333433353265
            36313030643064376265373938313436316435646362356631326539373133323932336439383663
            66366531313833386236613366353466353435653361326437343066643765366234396334346135
            61663564623938623733376566326339356562323331616338313335336663643234353364303736
            61616361303036363664633939396162666666323339376234386166336561626462333639636562
            6535
        - !vault |
            $ANSIBLE_VAULT;1.1;AES256
            32613833303033383335656437656334396335336632333130636462323436343031653735303035
            3262323864356531333139366166636134613535316330390a616337633539623365383631383839
            32353835373437613466363731643831626162633365633233656532336666616539386538633039
            6537623738333333640a386636643731373034616338643838393537333864373837336232393934
            32323962393065383438376434643632623632653365333736626636356636313533353739643735
            64623761383963366366303461633161663562386231343532393133663032346666643631376464
            31306336643332373661366664633632303765333266356439313530336239336539366663353438
            62376564376563663836343533306130643832393131363264326339633566373539613339346262
            3164
        - !vault |
            $ANSIBLE_VAULT;1.1;AES256
            35386234303333623938393665326439333330633630623837343438393337383930323630366632
            3163393434343266383461626631346433613730626535620a346562643065393733393633363464
            35333438643965623933303431363664343136613736313937353937633932356137663637613637
            3232313433303465390a336630653364376661336530376236303963383363626537643834616461
            31346237333138633331346663643066643732663635326661656666306433396139336438626665
            66363831643531383235353839663666656262343433386163623036623637326662383539633435
            34626439646462373465373063376239666435346262366262626333663638346334346637643938
            63336563616565353839
        remove_acl_users: []
        acl_users: *gdg_acl_deployers
        domains:
        - kyiv.gdg.org.ua
        - www.kyiv.gdg.org.ua
        wordpress: true
        ssl: true
        email: *letsencrypt_email

  - import_role:
      name: ansible-role-rclone
    become: yes
    become_method: sudo
    vars:
      rclone_config_file: /etc/rclone.conf
      # Configuration settings definition dictionary. You can copy it directly from
      # the rclone config file (I know, it requires you to setup it manually first
      # in order to get these parameters).
      rclone_config:
        drive:
          type: drive
          client_id: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            33393332663430396335373438623833633732366133323034376234323465313562356432613765
            3162393763363062363831306363303465646532376561650a386433323061363561616538353465
            65326135343966343036346532393430373436653930353336383831323363336531316131633963
            3230653038386138320a643138666531393562323131386432326632633261346539363236303061
            36616661636631336662306333363731656363633564393035653237663430343530323538336435
            37633562323535623963373039366565303964616165303965653936613330303938633734303837
            30636133323861616364343061623834623131373432666164306132383233326331336439316565
            30363834303664623638
          client_secret: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            36383536613336386634623464613839613862326337383662626335666434646465663466396363
            3630643533333561366664653965313339643535633732320a626431616638343932303764653165
            39373432303730633466336539356634386663633433353732396362356130633166306130613863
            3939363438666665610a363163386534393034323766316466643737393733383166303737346238
            61323130663633633331343532343936383831323638326562306664346262633165
          token: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            37386134666264326635653839386135306230343033636365626330663565643735373734376163
            3439333730303363663532636332633438653538323666350a393238346264323264356661386232
            65373537623264306238653964323162373434653839633365333663613133323732393633353836
            3937336531646134660a373534326162386461323463663962633137343063393363393930373163
            63613539616164373164383030343633336339343138396632656530356265313239323330643536
            65623231393636363430386330616637646662356331336335646131313134336465356333313663
            38666533383131646235623431396663663139323838353031316334356136326332613439393531
            33323664386234343032613863643131326538363932316234646163326163386231653936613562
            35643135363535613863353630613834613432623161383931373831393461653532303462643962
            35326133303432383231333635303462383137636630363336343631393637333335636334346235
            36636332396134653133323237653533663064626431636563666330666561663262393265666235
            38373839353133343734313834613336386231346233383833323239653431373463316339393530
            31316263643631646331613138373530303932663735363036626639633538373638663334373433
            65386162306439383666363463363932363164303731333966663337616432393132633566313630
            61363131623131656236353933633662343862383661346161616261666435653531613633663333
            62363138386664663038306631646466376238386166376163663030613163363731366264663466
            36623166373331353534663330363934643939363661633634616433646232346263306531663135
            3635303331363662356136643739323663633738646564373334

        encrypt:
          type: crypt
          remote: drive:backups/dokku
          filename_encryption: standard
          password: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            61653764653738396264326437626430633837376130373935656461323863653065386636373663
            3032323939613533386434646264386464306135326533380a376165646662303738303264653938
            65393137346564383431613964623038623731623765356161343931323633366565363630316564
            3336653164333061380a333738613562626166376233653261373462303664616139636463303364
            34363061396132376533633063333037626363643064386538623033366235386163633738666262
            30343863343534393438626363353037323033393132343963333535386363623830663334373333
            313937663233333261393765636461386263
          password2: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            39633563613233386162363733663534396533306661313965396464386531623236306662623863
            6231353935616239623766333064666438616139376161640a633736313530363764616639323633
            61303635393931613734643635636231363366366439666538643465633834626339336663346266
            6634306236323231340a393865353030373834326335383838373439636433636165643232346439
            61393137646139373464356562396632623830343835316232666337613531393430323163383139
            33663462633062643166666636323539663263633462623932663866653832636331316539323239
            386161663036613135616138326530386234

      #rclone_user: dokku
      #rclone_group: dokku
      rclone_user: root
      rclone_group: root

      # Backup definition settings
      rclone_backup_timer_enable: true
      rclone_backup_timer_state: started

      # run rclone every night at 03:46:08 a.m.
      rclone_backup_timer_cron: "*-*-* 03:46:08"
      rclone_backup_boot_delay: 15min

      # Folder backup definition list. Each item has
      #
      # enable: Enable systemd service, defaults to true
      # delete: Delete all files created, defaults to false
      # destination: Rclone configuration destination name
      # operation: Rclone command, defaults to sync
      # folder: Directory where to perform backups from
      # args: Additional arguments for the command, defaults to --copy-links
      # osd_notify_user: enabled osd notifications to the specified user
      # (you need X system running!)
      #
      rclone_backups:
      - destination: encrypt:dokku
        folder: /var/lib/dokku/backups
        args: -v --copy-links --one-file-system
        filters:
        - "- .Private/"
        - "- .atom/"
        - "- .adobe/"
        - "- .mozilla/"
        - "- .macromedia/"
        - "- .gvfs/"
        - "- .gnome2_private/"
        - "- .cache/"
        - "- .dotfiles/"
        - "- .ecryptfs/"
        - "- .bundle/"
        - "- .bosh/"
        - "- .bosh_init/"
        - "- .dropbox*/"
        - "- .glide/"
        - "- .thumbnails/"
        - "- .vagrant.d/"
        - "- .gem/"
        - "- .ansible/"
        - "- .bundle/"
        #osd_notify_user: null

# vim: ft=ansible:
